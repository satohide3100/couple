#!/bin/bash -e

# If running the rails server then create or migrate existing database
if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
  # Create symlink from uploads to persistent volume if volume exists
  if [ -d "/rails/storage" ]; then
    # Ensure volume directory exists and create symlink
    sudo mkdir -p /rails/storage/uploads
    sudo chown -R rails:rails /rails/storage/uploads
    
    # Remove existing uploads directory if it exists and create symlink
    sudo rm -rf /rails/uploads
    sudo ln -sf /rails/storage/uploads /rails/uploads
    
    # Also create tmp/uploads symlink for backup compatibility
    sudo rm -rf /rails/tmp/uploads
    sudo ln -sf /rails/storage/uploads /rails/tmp/uploads
    
    # Ensure rails user owns the symlinks
    sudo chown -h rails:rails /rails/uploads /rails/tmp/uploads
  else
    # Fallback to uploads directory if no volume
    mkdir -p /rails/uploads
    mkdir -p /rails/tmp/uploads
  fi
  
  ./bin/rails db:prepare
fi

exec "${@}"
